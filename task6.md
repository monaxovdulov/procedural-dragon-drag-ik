# Task 6: Anchor-Привязка Лап К Телу + Вязкий Шаг + Наружные Колени

## Контекст

Сейчас визуально заметны дефекты:

1. **Critical**: лапы выглядят оторванными от тела (точка крепления не “прилипает” к позвонку и не вращается вместе с ним).
2. Движение шага слишком резкое (перенос выглядит как скачок/линейная “протяжка”).
3. “Корявые” колени: IK иногда выбирает конфигурацию, где колено заворачивается внутрь.

В коде проекта класс “ящерицы” называется `Dragon` (а не `Lizard`). Эту задачу пишем для `Dragon` + `Leg`.

## Цель

- Жёстко привязать `anchor_point` каждой ноги к конкретному сегменту позвоночника на каждом кадре:
  `anchor = spine_pos + perp(spine_angle) * (body_radius * side_sign)`.
- Сделать перенос лапы вязким и читаемым через фазу шага `step_progress` + easing + дугу (sin).
- Принудительно выбирать IK-решение с “наружным” коленом относительно тела (outward bending).

## Файлы

- `main.py`

## План изменений

### 1) Жёсткая привязка anchor_point (Critical)

Проблема: визуально кажется, что бедро/плечо не следует за корпусом.

Решение:

1. В `Dragon.update()` для каждой ноги каждый кадр пересчитывать `anchor` (и только от него считать `hip`):
   - взять `spine_pos = points[attach_idx]`
   - взять локальный базис сегмента: `t, n = _frame_at(attach_idx)`
   - `body_r = _radius_at(attach_idx)`
   - `anchor = spine_pos + n * (leg.side * body_r)`
   - `hip = anchor + n * (leg.side * leg_hip_offset)` (опционально, если нужен “сустав” за пределами кожи)
2. Запретить использование каких-либо “накопленных” координат бедра: `hip/anchor` всегда функция от позвоночника текущего кадра.

Критерий: при резком повороте/изгибе корпуса точка крепления лапы не “отстаёт” и не висит отдельно.

### 2) Вязкий шаг: step_progress + lerp + дуга

Проблема: перенос лапы воспринимается как скачок или “прямая протяжка”.

Решение:

1. В `Leg` хранить:
   - `is_stepping: bool`
   - `step_progress: float` (0..1)
   - `step_start: Vector2`
   - `step_target: Vector2`
   - `foot_pos: Vector2` (текущая позиция для позы/рендера; в stance должна совпадать с “липкой” опорой)
2. Триггер шага:
   - stance: `foot_pos` фиксирован в мире, `hip/anchor` ползёт вместе с телом
   - если `distance(desired, foot_pos) > threshold`, то:
     `is_stepping = True`, `step_progress = 0`,
     `step_start = foot_pos`, `step_target = predicted_target`
3. Swing-phase (перенос):
   - `step_progress += dt / step_duration`
   - `p = clamp(step_progress, 0, 1)`
   - `s = smoothstep(p)` (можно 2-3 раза или quintic easing для “вязкости”)
   - `pos = lerp(step_start, step_target, s)`
   - дуга: взять направление шага `dir = normalize(step_target - step_start)`
     и перпендикуляр `perp = (-dir.y, dir.x)`.
     Добавить смещение по перпендикуляру:
     `pos += perp * (sin(p * PI) * step_height)`.
4. Завершение шага:
   - при `p >= 1`: `is_stepping = False`, `foot_pos = step_target`

Критерий: перенос читается как дуга, движение “в воде”, без резких рывков.

### 3) IK: колено наружу (outward bending)

Проблема: колено иногда выбирает внутреннюю конфигурацию.

Решение:

1. “Наружу” определить относительно локальной нормали сегмента:
   - `out_dir = n * leg.side` (наружу от тела для данной ноги)
2. Вариант A (простой):
   - задавать `bend_dir` так, чтобы колено всегда оказывалось на стороне `out_dir`.
   - если IK решатель принимает `bend_dir` (+1/-1), подобрать знак через тест:
     вычислить knee для `bend_dir=+1` и `bend_dir=-1`, выбрать тот, где:
     `(knee - hip).dot(out_dir) > 0`.
3. Вариант B (дешевле, но менее надёжно):
   - фиксировать `bend_dir` от `leg.side` и не умножать на “направление движения”.

Критерий: при любых поворотах корпуса колено не выворачивается внутрь.

## Definition Of Done

- Anchor/hip жёстко следует за `attach_idx` на каждом кадре, без визуального “отрыва”.
- Перенос лапы всегда плавный: `step_progress` + easing + дуга `sin(p*PI)`.
- IK всегда выбирает “наружное” колено.
- Диагональная походка сохраняется (не стартуют все лапы одновременно).

## Ручная проверка

1. `uv run main.py`
2. Резко дёрнуть мышью, быстро менять направление: лапы не “висят” отдельно от тела.
3. Остановиться: stance стабилен, опоры не ползут.
4. В swing видна дуга и “вязкость”, нет телепорта.
5. Колени всегда наружу (проверить на сильных изгибах).
