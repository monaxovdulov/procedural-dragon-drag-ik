# Task 7: Размашистая Походка (Wide Stance & Long Stride)

## Контекст

Сейчас дракон перебирает лапами слишком близко к центральной оси тела (Spine). Это выглядит неустойчиво, как будто он идёт “по канату”, а не ползёт как рептилия.

У настоящих ящериц походка “распластанная” (sprawling posture): плечи/таз широко расставлены, локти/колени торчат наружу, стопы ставятся далеко по бокам.

## Проблема: Слишком узкая постановка ног (Cramped Gait)

- Текущий `leg_spread` (lateral offset) слишком мал, поэтому `desired_foothold` получается близко к позвоночнику.
- Из-за узкой базы опоры шаг выглядит “семенящим” и неустойчивым.

## Цель

1. Увеличить боковой вылет лап (wide stance), чтобы стопы ставились заметно дальше от тела.
2. Увеличить длину шага (long stride), чтобы походка была размашистой.
3. Добавить лимит по досягаемости IK, чтобы цель шага не улетала дальше максимально выпрямленной ноги (иначе лапа будет “отрываться”).

## Файлы

- `main.py`

## План изменений

### 1) Увеличить `leg_spread` по умолчанию (Sprawling posture)

Требование: `leg_spread` по умолчанию должен быть **минимум 70%** от полной длины ноги:

- `leg_len = leg_upper + leg_lower`
- `leg_spread_default >= 0.70 * leg_len`

Практически:

- Обновить дефолты параметров (и в UI):
  - `leg_spread`: `range(10, 150)`, `default = 70` (или выше, если `0.7 * leg_len > 70`)
  - `stride_front`: `range(10, 150)`, `default = 90`
  - `stride_back`: `range(10, 150)`, `default = 80`
  - `step_lift`: увеличить `default` до `15..20` (чтобы при длинном шаге лапа заметно поднималась)

### 2) Исправить расчёт цели шага (Target Foot Position / Home Position)

Целевая позиция стопы должна быть намного дальше от тела по локальной нормали сегмента, а не “под животом”.

Базовая формула для “идеальной” позиции опоры:

- `ideal_pos = hip_bone_pos + (spine_normal * side_sign * (body_radius + leg_spread))`

где:

- `spine_normal` берётся из локального базиса сегмента (`_frame_at(idx) -> n`)
- `side_sign` это `leg.side` (`+1/-1`)
- `body_radius` это `_radius_at(idx)`

Важно: убедиться, что именно эта компонента (по `n`) задаёт широкий вылет, а не небольшой визуальный сдвиг.

### 3) Лимит досягаемости IK (Max Reach Clamp)

Проблема: при поворотах тела “идеальная” цель может оказаться дальше, чем длина выпрямленной ноги, что визуально выглядит как отрыв лапы от тела.

Решение: перед стартом шага (и/или перед IK) ограничивать цель:

- `max_reach = (leg_upper + leg_lower) - epsilon`
- если `dist(hip, target) > max_reach`:
  - `target = hip + normalize(target - hip) * max_reach`

Критерий: при резких изгибах корпуса лапа не “рвётся” к недостижимой цели.

### 4) Длинный шаг (Stride Defaults)

- Увеличить дефолтные `stride_front/stride_back` (и диапазон слайдеров), чтобы шаг был длинным и читаемым.
- Проверить, что диагональный gait остаётся стабильным: при более широких целях нога не должна начинать шаги “вразнобой”.

### 5) IK/колени при wide stance

После увеличения `leg_spread` убедиться, что:

- колени/локти всё ещё сгибаются наружу (outward bending),
- поза не выглядит “сломано” на максимальном `leg_spread`.

## Definition Of Done

- На дефолтных параметрах стопы стоят широко по бокам (не рядом с позвоночником).
- Походка выглядит как у геккона/саламандры: широкая база опоры, локти/колени наружу.
- При резких поворотах корпуса цель шага не выходит за `max_reach`, визуального “отрыва” от тела нет.
- Слайдеры не “зажаты”: `leg_spread/stride_*` имеют адекватные диапазоны (до 150).

## Ручная проверка

1. `uv run main.py`
2. Пресет `F1` (“quadruped_real”) должен сразу давать wide stance.
3. `D` debug: цели шага/опоры заметно отнесены от позвоночника по нормали.
4. Резко менять направление мышью: лапы не “отрываются” (цель зажата `max_reach`).
